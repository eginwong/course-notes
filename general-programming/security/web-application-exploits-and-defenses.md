# Web Application Exploits and Defenses
[ref](https://google-gruyere.appspot.com/part3#3__cross_site_request_forgery)

## Slide Content
- aka one-click attack, session riding
- prevention
  - create per-session CSRF token that is unique
  - Cookie-to-header token: Angular and Django have implemented it
- just because protected from XSS, doesn't mean CSRF isn't possible
- famous vulnerabilities:
  - ING direct (additional accounts can be created per user, and able to transfer funds out)
  - YouTube (add videos to a user's favourites, shared videos with contacts, subscribe to new channel)
  - Netflix
- `<img src="https://www.example.com/transfer?amount=1000&amp;destination=mallory">`
- three conditions for vulnerabilities
  - relevant action for attacker to use
  - cookie-based session handling (can inspect requests)
  - predictable request params (the attacker can guess the param/avoid it)
- if user is logged in to vulnerable website, their browser will automatically include session cookie in the request
- unauthorized commands are transmitted from a user that the web app trusts


## Cross-Site Request Forgery (XSRF/CSRF)
[wiki](https://en.wikipedia.org/wiki/Cross-site_request_forgery)
- aka one-click attack, session riding
- unauthorized commands are transmitted from a user that the web app trusts
- involves sites that rely on a user's identity; exploits the site's trust in that identity; tricks the user's browser into sending HTTP requests to a target site; involves HTTP requests that have side effects
- prevention
  - create per-session CSRF token that is unique
  - Cookie-to-header token: Angular and Django have implemented it
    - undermined by: Access-Control-Allow-Origin: *
    - allows an application to make calls to other domains to request information

[freedom-to-tinker](https://freedom-to-tinker.com/2008/09/29/popular-websites-vulnerable-cross-site-request-forgery-attacks/)
- most apps do not verify that the user is invoking the action but rather that the request came from the browser of the authorized user
- just because protected from XSS, doesn't mean CSRF isn't possible
- famous vulnerabilities:
  - ING direct (additional accounts can be created per user, and able to transfer funds out)
  - YouTube (add videos to a user's favourites, shared videos with contacts, subscribe to new channel)

[tinfoil-security](https://www.tinfoilsecurity.com/blog/what-is-cross-site-request-forgery-csrf)
- `<img src="https://www.example.com/transfer?amount=1000&amp;destination=mallory">`
- can reset passwords/change emails if not careful
- SOLUTION
- make all important actions only over POST
- server should generate unique token and store in session cookie
  - also digitally signed
  - include token as hidden field into every form on every page rendered from server
  - token should be sent on all POST requests as a form param, as well as in the cookie
    - server checks if these two are the same
    - if not, forgery

[port-swigger](https://portswigger.net/web-security/csrf)
- ![image](https://portswigger.net/web-security/images/cross-site%20request%20forgery.svg)
- three conditions for vulnerabilities
  - relevant action for attacker to use
  - cookie-based session handling (can inspect requests)
  - predictable request params (the attacker can guess the param/avoid it)
- if user is logged in to vulnerable website, their browser will automatically include session cookie in the request

[OWASP](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF))
- only using POST does not work
- using a secret cookie can still be exposed
- URL rewriting/multi-step transactions can still be spoofed
- HTTPS will not help
- How to get affected?
  - just loading images can cause problems
  - `<img src="http://bank.com/transfer.do?acct=MARIA&amount=100000" width="0" height="0" border="0">`
  - can even submit forms (POSTs) with `<body onload="document.forms[0].submit()">`
  - TODO: Image of the email prompt from Outlook
- that's what CORS can enable or disable, based on the setting

[Gruyere](https://google-gruyere.appspot.com/part3#3__cross_site_request_forgery)
- sample exercises